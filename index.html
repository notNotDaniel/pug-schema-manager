<!DOCTYPE html>
<html lang="en">
  
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Typelevel Laika + Helium Theme" />
  <title>Pug Schema Manager</title>
  
  <meta name="author" content="pug-schema-manager contributors"/>
  
  <meta name="author" content="Daniel Keller"/>
  
  
  <meta name="description" content="docs"/>
  
  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:500">
  
  <link rel="stylesheet" type="text/css" href="helium/site/icofont.min.css" />
    <link rel="stylesheet" type="text/css" href="helium/site/laika-helium.css" />
  <script src="helium/site/laika-helium.js"></script>
  
  
  <script> /* for avoiding page load transitions */ </script>
</head>

  <body>

    <header id="top-bar" class="light-default dark-default">

  <div class="row">
    <a id="nav-icon">
      <i class="icofont-laika navigationMenu" title="Navigation">&#xefa2;</i>
    </a>
    
    
  </div>

  <a class="icon-link glyph-link" href="https://pugcode.works"><i class="icofont-laika home" title="Home">&#xef47;</i></a>

  <div class="row links">
    
    <a class="icon-link svg-link" href="https://github.com/notNotDaniel/pug-schema-manager"><span class="github" title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
    
  </div>  

</header>
    
    <nav id="sidebar">

  <div class="row">
    
    <a class="icon-link svg-link" href="https://github.com/notNotDaniel/pug-schema-manager"><span class="github" title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
    
  </div>

  <ul class="nav-list">
    <li class="level1 active nav-leaf"><a href="#">Pug Schema Manager</a></li>
  </ul>

</nav>

    <div id="container">

      
<nav id="page-nav">
  <p class="header"><a href="#">Pug Schema Manager</a></p>

  <ul class="nav-list">
    <li class="level1 nav-leaf"><a href="#quickstart">Quickstart</a></li>
    <li class="level1 nav-leaf"><a href="#specifying-migration-actions">Specifying Migration Actions</a></li>
  </ul>

  <p class="footer"></p>
</nav>


      <main class="content">

        <h1 id="pug-schema-manager" class="title">Pug Schema Manager</h1>
        <p>A purely functional toolkit for using <a href="https://tpolecat.github.io/doobie/index.html">Doobie</a>
        to manage your database schemata.</p>
        
        <h2 id="quickstart" class="section"><a class="anchor-link left" href="#quickstart"><i class="icofont-laika link">&#xef71;</i></a>Quickstart</h2>
        <p>Add the necessary dependency, e.g. in <code>build.sbt</code></p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="identifier">libraryDependencies</span><span> += </span><span class="string-literal">&quot;works.pugcode&quot;</span><span> % </span><span class="string-literal">&quot;pug-schema-manager&quot;</span><span> %% </span><span class="string-literal">&quot;0.1.0&quot;</span></code></pre>
        <p>Define a schema component. This is a set of related SQL which should be versioned (and migrated)
        together.</p>
        <p>At a minimum, this must include the <code>currentVersion</code> number (an integer which is
        incremented each time a migration needs to be applied), and <code>currentSchema</code>, which is the complete
        definition of the current version of the schema, and will be applied if the schema does not yet
        exist in any form.</p>
        <p>You may also define a set of migrations, which specify the incremental steps to migrate from previous
        versions of the schema to the current one. These are defined as a partial function from a
        <code>(fromVersion, toVersion)</code> tuple to the migration steps to be performed. Migrations are applied
        atomically, in order, to advance the database&#39;s current version to the one defined by code. If
        migrations exist to advance more than one version, the migration which advances the current version
        as far as possible will be applied.</p>
        <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">doobie</span><span>.</span><span class="identifier">implicits</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">pug</span><span>.</span><span class="identifier">schema</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">object</span><span> </span><span class="type-name">PetsSchema</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">SchemaComponent</span><span>(</span><span class="string-literal">&quot;pets&quot;</span><span>) {
  </span><span class="keyword">val</span><span> </span><span class="identifier">currentVersion</span><span> = </span><span class="number-literal">2</span><span>

  </span><span class="keyword">val</span><span> </span><span class="identifier">currentSchema</span><span> = </span><span class="string-literal">sql&quot;&quot;&quot;
    CREATE TABLE cats (
      name CHARACTER VARYING PRIMARY KEY,
      ennui REAL CHECK (ennui &gt; 0),
      frolic_factor REAL CHECK (frolic_factor &gt; 0)
    );
  &quot;&quot;&quot;</span><span>

  </span><span class="keyword">override</span><span> </span><span class="keyword">val</span><span> </span><span class="identifier">migrations</span><span> = {
    </span><span class="keyword">case</span><span> (</span><span class="number-literal">1</span><span>, </span><span class="number-literal">2</span><span>) =&gt; </span><span class="string-literal">sql&quot;&quot;&quot;
      ALTER TABLE cats ADD COLUMN frolic_factor REAL
        CHECK (frolic_factor &gt; 0);
    &quot;&quot;&quot;</span><span>
  }
}</span></code></pre>
        <p>The metadata maintained by the schema manager, as well as any required migrations, can be applied
        by executing the effect returned from the <code>SchemaManager.bootstrap()</code> method</p>
        <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.{</span><span class="type-name">ExitCode</span><span>, </span><span class="type-name">IO</span><span>, </span><span class="type-name">IOApp</span><span>}
</span><span class="keyword">import</span><span> </span><span class="identifier">doobie</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">doobie</span><span>.</span><span class="identifier">implicits</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">pug</span><span>.</span><span class="identifier">schema</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">object</span><span> </span><span class="type-name">MyPetsApp</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">IOApp</span><span> {
  </span><span class="keyword">val</span><span> </span><span class="identifier">schemaManagement</span><span> = </span><span class="keyword">new</span><span> </span><span class="type-name">SchemaManagement</span><span>()
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">transactor</span><span> = </span><span class="type-name">Transactor</span><span>.</span><span class="identifier">fromDriverManager</span><span>[</span><span class="type-name">IO</span><span>](
    </span><span class="string-literal">&quot;org.h2.Driver&quot;</span><span>,
    </span><span class="string-literal">&quot;jdbc:h2:mem:example;USER=sa;DB_CLOSE_DELAY=-1;MODE=PostgreSQL;DATABASE_TO_LOWER=TRUE&quot;</span><span>
  )

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">run</span><span>(</span><span class="identifier">args</span><span>: </span><span class="type-name">List</span><span>[</span><span class="type-name">String</span><span>] = </span><span class="type-name">List</span><span>()): </span><span class="type-name">IO</span><span>[</span><span class="type-name">ExitCode</span><span>] =
    </span><span class="keyword">for</span><span> {
      </span><span class="identifier">_</span><span> &lt;- </span><span class="identifier">schemaManagement</span><span>.</span><span class="identifier">bootstrap</span><span>(</span><span class="type-name">PetsSchema</span><span>).</span><span class="identifier">transact</span><span>(</span><span class="identifier">transactor</span><span>)
    } </span><span class="keyword">yield</span><span> </span><span class="type-name">ExitCode</span><span>.</span><span class="type-name">Success</span><span>
}</span></code></pre>
        
        <h2 id="specifying-migration-actions" class="section"><a class="anchor-link left" href="#specifying-migration-actions"><i class="icofont-laika link">&#xef71;</i></a>Specifying Migration Actions</h2>
        <p>Migration steps (as well as the initial schema creation) can be specified in a variety of ways:</p>
        <ul>
          <li>
            <p>Ultimately, all migration steps reduce to a sequence of Doobie <code>ConnectionIO[Unit]</code>, which are
            applied transactionally.</p>
            <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">stepX</span><span> =
  </span><span class="keyword">for</span><span> {
    </span><span class="identifier">id</span><span> &lt;- </span><span class="string-literal">sql&quot;insert into my_table (name) values (</span><span class="substitution">$name</span><span class="string-literal">)&quot;</span><span>
            .</span><span class="identifier">update</span><span>
            .</span><span class="identifier">withUniqueGeneratedKeys</span><span>[</span><span class="type-name">Int</span><span>](</span><span class="string-literal">&quot;id&quot;</span><span>)
    </span><span class="identifier">_</span><span>  &lt;- </span><span class="string-literal">sql&quot;insert into my other table (name, id) values (</span><span class="substitution">$name</span><span class="string-literal">, </span><span class="substitution">$id</span><span class="string-literal">)&quot;</span><span>
            .</span><span class="identifier">update</span><span>
  } </span><span class="keyword">yield</span><span> ()</span></code></pre>
          </li>
          <li>
            <p>Steps may also be specified as Doobie as simple <code>sql</code> fragments, e.g.</p>
            <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">stepY</span><span> = </span><span class="string-literal">sql&quot;UPDATE foo SET bar = baz&quot;</span></code></pre>
          </li>
        </ul>

        
<hr class="footer-rule"/>
<footer>
  Site generated by <a href="https://typelevel.org/Laika/">Laika</a> with the Helium theme.
</footer>


      </main>

    </div>

  </body>

</html>